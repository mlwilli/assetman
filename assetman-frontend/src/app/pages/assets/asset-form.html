<mat-card class="card">
  <ng-container *ngIf="state$ | async as s">
    <mat-progress-bar *ngIf="s.kind === 'loading'" mode="indeterminate"></mat-progress-bar>

    <div class="error" *ngIf="s.kind === 'error'">
      <strong>Unable to load form.</strong>
      <div class="error-message">{{ s.message }}</div>
      <div class="actions">
        <a mat-button routerLink="/assets">Back to Assets</a>
      </div>
    </div>

    <ng-container *ngIf="s.kind === 'ready'">
      <div class="header">
        <h2 class="title">
          {{ s.mode === 'create' ? 'Create Asset' : 'Edit Asset' }}
        </h2>

        <div class="actions">
          <a mat-button routerLink="/assets">Cancel</a>
          <a *ngIf="s.mode === 'edit' && s.asset" mat-button [routerLink]="['/assets', s.asset.id]">View</a>
        </div>
      </div>

      <form class="form" [formGroup]="form" (ngSubmit)="submit(s.mode, s.asset)">
        <div class="grid">
          <mat-form-field appearance="outline">
            <mat-label>Name</mat-label>
            <input matInput formControlName="name" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Status</mat-label>
            <mat-select formControlName="status">
              <mat-option value="" disabled>Select status</mat-option>
              <mat-option *ngFor="let o of statusOptions" [value]="o.value">
                {{ o.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Category</mat-label>
            <input matInput formControlName="category" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Code</mat-label>
            <input matInput formControlName="code" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Asset Tag</mat-label>
            <input matInput formControlName="assetTag" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Serial Number</mat-label>
            <input matInput formControlName="serialNumber" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Manufacturer</mat-label>
            <input matInput formControlName="manufacturer" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Model</mat-label>
            <input matInput formControlName="model" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>External Ref</mat-label>
            <input matInput formControlName="externalRef" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="full">
            <mat-label>Tags (comma-separated)</mat-label>
            <input matInput formControlName="tagsCsv" placeholder="e.g. electrical, floor-2, critical" />
          </mat-form-field>

          <!-- Location Picker -->
          <div class="full location-filter">
            <label>Location</label>
            <app-location-picker
              [selectedId]="selectedLocationId"
              (selectedIdChange)="onLocationSelected($event)"
            />
          </div>

          <app-property-picker
            class="full"
            [selectedId]="form.value.propertyId || null"
            (selectedIdChange)="onPropertySelected($event)"
          ></app-property-picker>

          <app-unit-picker
            class="full"
            [propertyId]="selectedPropertyId"
            [selectedId]="form.value.unitId || null"
            (selectedIdChange)="form.patchValue({ unitId: $event ?? '' })"
          ></app-unit-picker>

          <app-user-picker
            class="full"
            [selectedId]="form.value.assignedUserId || null"
            (selectedIdChange)="form.patchValue({ assignedUserId: $event ?? '' })"
          ></app-user-picker>


          <mat-form-field appearance="outline">
            <mat-label>Purchase Date</mat-label>
            <input matInput [matDatepicker]="purchasePicker" formControlName="purchaseDate" />
            <mat-datepicker-toggle matIconSuffix [for]="purchasePicker"></mat-datepicker-toggle>
            <mat-datepicker #purchasePicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>In Service Date</mat-label>
            <input matInput [matDatepicker]="inServicePicker" formControlName="inServiceDate" />
            <mat-datepicker-toggle matIconSuffix [for]="inServicePicker"></mat-datepicker-toggle>
            <mat-datepicker #inServicePicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Retired Date</mat-label>
            <input matInput [matDatepicker]="retiredPicker" formControlName="retiredDate" />
            <mat-datepicker-toggle matIconSuffix [for]="retiredPicker"></mat-datepicker-toggle>
            <mat-datepicker #retiredPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Disposed Date</mat-label>
            <input matInput [matDatepicker]="disposedPicker" formControlName="disposedDate" />
            <mat-datepicker-toggle matIconSuffix [for]="disposedPicker"></mat-datepicker-toggle>
            <mat-datepicker #disposedPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Warranty Expiry</mat-label>
            <input matInput [matDatepicker]="warrantyPicker" formControlName="warrantyExpiryDate" />
            <mat-datepicker-toggle matIconSuffix [for]="warrantyPicker"></mat-datepicker-toggle>
            <mat-datepicker #warrantyPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Purchase Cost</mat-label>
            <input matInput formControlName="purchaseCost" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Residual Value</mat-label>
            <input matInput formControlName="residualValue" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Depreciation Years</mat-label>
            <input matInput formControlName="depreciationYears" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="full">
            <mat-label>Custom Fields JSON</mat-label>
            <textarea matInput rows="5" formControlName="customFieldsJson"></textarea>
          </mat-form-field>
        </div>

        <div class="footer">
          <button mat-raised-button color="primary" type="submit">
            {{ s.mode === 'create' ? 'Create' : 'Save' }}
          </button>
        </div>
      </form>
    </ng-container>
  </ng-container>
</mat-card>
